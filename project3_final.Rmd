---
title: "Project 3: Transportability Analysis"
subtitle: "[Github Link](https://github.com/Rosy98/PHP2550-Project-3)"
author: "Zihan Zhou"
date: "`r Sys.Date()`"
abstract: |
  \item[Aim:] This project aims to evaluate the performance of a risk prediction model for cardiovascular diseases (CVD) across two different populations: Framingham Heart Study and National Health and Nutrition Examination Survey (NHANES) population. The model is developed using data from Framingham and then evaluate its transportability to the NHANES population and simulated NHANES dataset. The outcome data is not available in the NHANES cohort.
  \item[Method:] The Brier Score is used as a measure of predictive accuracy for the logistic prediction models for men and women based on the Framingham data. These models were then applied to both the NHANES population and the simulated NHANES population based on the summary statistics. Gamma and Binomial distributions are used to simulated the NHANSE population with a simulation size of 2000.
  \item[Result:] The analysis reveals that the model for women achieves a higher Brier Score than the model for men across all three datasets. When transported to the NHANES population, the model yields the highest Brier Score, suggesting a potential decrease in predictive accuracy. Conversely, the model attains the lowest Brier Scores on the simulated NHANES data, indicating a lack of complexity in the simulated covariates compared to real-world data.
  \item[Limitations:] The results highlight the challenges of transporting prediction models across diverse populations, highlighting the impact of varying covariate distributions on model performance. The transportability of the Brier Score is limited by two identification conditions. Future research could focus on additional performance metrics such as AUC and developing methods to better address missing data.
output: pdf_document
bibliography: project3.bib
csl: ieee.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE, fig.align = "center")
```

```{r}
# load library
library(riskCommunicator)
library(tidyverse)
library(tableone)
library(ggplot2)
library(ggpubr)
library(DescTools)
library(pROC)
library(mice)
library(knitr)
library(kableExtra)
library(gtsummary)
```

# 1. Introduction

Assessing the performance of prediction models is one of the crucial aspects when developing a model. Usually, the development of prediction models is driven by predictions within a specific target population. In the healthcare system, these prediction models are desired to be deployed to identify individuals at high risk for certain diseases across different populations. The data used to develop the model, referred to as the source study data, often come from randomized trials [@pajouheshniaWhenHowUse2019], large observational databases [@goldsteinOpportunitiesChallengesDeveloping2017], or prospective cohort studies. However, these sources may not represent random samples of the target population, leading to potential disparities in data distribution. This discrepancy makes it difficult to derive the accurate assessment of a model's performance on the target population, as performance metrics derived from the source population may not translate directly to the target population. For instance, the Framingham ATP-III model [@nationalcholesteroleducationprogramncepexpertpanelondetectionevaluationandtreatmentofhighbloodcholesterolinadultsadulttreatmentpaneliiiThirdReportNational2002], designed to predict the 10-year risk of cardiovascular events and primarily developed from data with predominantly white participants, has shown limited generalizability to multi-ethnic populations.

When assessing the performance on external dataset, challenges may arise when only covariate data are available. Due to the differences in data distribution compared to the source data, the outcome data can also have different distribution. For example, the Framingham Heart study [@dagostinoGeneralCardiovascularRisk2008] provides both covariate and outcome data, while the National Health and Nutrition Examination Survey (NHANES) [@NHANESNationalHealth] only has covariate data. This lack of outcome information from the target population limits the ability to develop or assess prediction models using data solely from the target population. In recent years, several methods have been introduced to evaluate prediction model performance in a target population, or to transfer performance measures from the source to the target population.

This project aims to apply a newly developed method that uses covariate and outcome data from the source population to bridge for the differences in data distributions between the two populations [@steingrimssonTransportingPredictionModel2023a]. The approach will be applied to a risk score model developed on the Framingham Heart Study data. The objective is to estimate the model's performance in a population represented by the NHANES survey data, utilizing a simulation study. The risk score model developed will be gender-specific.

# 2. Data

```{r}
data("framingham")

# The Framingham data has been used to create models for cardiovascular risk.
# The variable selection and model below are designed to mimic the models used
# in the paper General Cardiovascular Risk Profile for Use in Primary Care 
# This paper is available (cvd_risk_profile.pdf) on Canvas.
```

```{r, results='hide'}
framingham_df <- framingham %>% select(c(CVD, TIMECVD, SEX, TOTCHOL, AGE,
                                      SYSBP, DIABP, CURSMOKE, DIABETES, BPMEDS,
                                      HDLC, BMI))
framingham_df <- na.omit(framingham_df)

CreateTableOne(data=framingham_df, strata = c("SEX"))

# Get blood pressure based on whether or not on BPMEDS
framingham_df$SYSBP_UT <- ifelse(framingham_df$BPMEDS == 0, 
                                 framingham_df$SYSBP, 0)
framingham_df$SYSBP_T <- ifelse(framingham_df$BPMEDS == 1, 
                                framingham_df$SYSBP, 0)

# Looking at risk within 15 years - remove censored data
dim(framingham_df)
framingham_df <- framingham_df %>%
  filter(!(CVD == 0 & TIMECVD <= 365*15)) %>%
  select(-c(TIMECVD))
dim(framingham_df)

# Filter to each sex
framingham_df_men <- framingham_df %>% filter(SEX == 1)
framingham_df_women <- framingham_df %>% filter(SEX == 2)

```

```{r, results='hide'}
# The NHANES data here finds the same covariates among this national survey data
library(nhanesA)
# blood pressure, demographic, bmi, smoking, and hypertension info
bpx_2017 <- nhanes("BPX_J") %>% 
  select(SEQN, BPXSY1 ) %>% 
  rename(SYSBP = BPXSY1)
demo_2017 <- nhanes("DEMO_J") %>% 
  select(SEQN, RIAGENDR, RIDAGEYR) %>% 
  rename(SEX = RIAGENDR, AGE = RIDAGEYR)
bmx_2017 <- nhanes("BMX_J") %>% 
  select(SEQN, BMXBMI) %>% 
  rename(BMI = BMXBMI)
smq_2017 <- nhanes("SMQ_J") %>%
  mutate(CURSMOKE = case_when(SMQ040 %in% c(1,2) ~ 1,
                              SMQ040 == 3 ~ 0, 
                              SMQ020 == 2 ~ 0)) %>%
  select(SEQN, CURSMOKE)
bpq_2017 <- nhanes("BPQ_J") %>% 
  mutate(BPMEDS = case_when(
    BPQ020 == 2 ~ 0,
    BPQ040A == 2 ~ 0,
    BPQ050A == 1 ~ 1,
    TRUE ~ NA )) %>%
  select(SEQN, BPMEDS) 
tchol_2017 <- nhanes("TCHOL_J") %>% 
  select(SEQN, LBXTC) %>% 
  rename(TOTCHOL = LBXTC)
hdl_2017 <- nhanes("HDL_J") %>% 
  select(SEQN, LBDHDD) %>% 
  rename(HDLC = LBDHDD)
diq_2017 <- nhanes("DIQ_J") %>% 
  mutate(DIABETES = case_when(DIQ010 == 1 ~ 1, 
                              DIQ010 %in% c(2,3) ~ 0, 
                              TRUE ~ NA)) %>%
  select(SEQN, DIABETES) 

# Join data from different tables
df_2017 <- bpx_2017 %>%
  full_join(demo_2017, by = "SEQN") %>%
  full_join(bmx_2017, by = "SEQN") %>%
  full_join(hdl_2017, by = "SEQN") %>%
  full_join(smq_2017, by = "SEQN") %>%
  full_join(bpq_2017, by = "SEQN") %>%
  full_join(tchol_2017, by = "SEQN") %>%
  full_join(diq_2017, by = "SEQN")
CreateTableOne(data = df_2017, strata = c("SEX"))

df_2017$SYSBP_UT <- ifelse(df_2017$BPMEDS == 0, 
                                 df_2017$SYSBP, 0)
df_2017$SYSBP_T <- ifelse(df_2017$BPMEDS == 1, 
                                df_2017$SYSBP, 0)
```

```{r}
gt1 <- tbl_summary(framingham_df, include = -c(DIABP), by = SEX, missing = "no",
                   statistic = list(all_continuous() ~ "{mean} ({sd})"),
                   label = list(TOTCHOL ~ "Serum Total Cholesterol (mg/dL)",
                                SYSBP ~ "Systolic Blood Pressure",
                                CURSMOKE ~ "Current Cigarette Smoking",
                                DIABETES ~ "Diabetic",
                                BPMEDS ~ "Use of Anti-hypertensive Medication",
                                HDLC ~ "High Density Lipoprotein Cholesterol (mg/dL)",
                                SYSBP_UT ~ "Systolic Blood Pressure (No BPMEDS)",
                                SYSBP_T ~ "Systolic Blood Pressure (On BPMEDS)")) %>%
  add_p() %>%
  modify_header(label = "SEX") %>%
  bold_labels()
```

```{r}
gt2 <- tbl_summary(df_2017, include = -c(SEQN), by = SEX, missing = "no",
                   statistic = list(all_continuous() ~ "{mean} ({sd})"),
                   label = list(TOTCHOL ~ "Serum Total Cholesterol (mg/dL)",
                                SYSBP ~ "Systolic Blood Pressure",
                                CURSMOKE ~ "Current Cigarette Smoking",
                                DIABETES ~ "Diabetic",
                                BPMEDS ~ "Use of Anti-hypertensive Medication",
                                HDLC ~ "High Density Lipoprotein Cholesterol (mg/dL)",
                                SYSBP_UT ~ "Systolic Blood Pressure (No BPMEDS)",
                                SYSBP_T ~ "Systolic Blood Pressure (On BPMEDS)")) %>%
  add_p() %>%
  modify_header(label = "SEX") %>%
  bold_labels()
```

The Framingham and NHANES datasets have been cleaned and transformed to include the same covariates, with the eligibility criteria, particularly the age limitation from the Framingham study, applied to the NHANES sample. Both datasets are pre-processed to select covariates commonly used in CVD prediction models.

Table 1 presents a summary of the variables used in this transportability analysis. Key risk factors such as serum total cholesterol and systolic blood pressure exhibit statistically significant differences ($p$-value < 0.05 based on Pearson’s Chi-squared test and Wilcoxon rank sum test) between the cohorts. For example, the serum total cholesterol levels in NHANES is significantly lower than those in Framingham study for both gender. These differences in covariates highlights the challenge when transporting the risk score model from Framingham population to NHANES population.

```{r}
tbl_merge(list(gt1, gt2),
          tab_spanner = c("Framingham", "NHANES"))%>%
  as_kable_extra(booktabs = T, escape = F, align = "c", caption = "Summary of the variables used in the transportability analysis of CVD predictio model") %>%
  kable_styling(latex_options = c("HOLD_position", "scale_down"))
```

## 2.1 Framingham study

The Framingham Heart Study, conducted in Framingham, Massachusetts, is a long-term prospective investigation into the causes of cardiovascular disease (CVD) among a population of free living subjects. This study in epidemiology was pioneering as it was the first study to prospectively examine cardiovascular disease, introducing the concept of risk factors and their joint effects. The study started in 1948 and a total of 5,209 subjects were initially enrolled in the study. All research participants were constantly monitored for the emergence of CVD events and mortality. CVD is defined by the Framingham study as a composite of CHD (coronary death, myocardial infarction, coronary insufficiency, and angina), cerebrovascular events (including ischemic stroke, hemorrhagic stoke, and transient ischemic attack), peripheral artery disease (intermittent claudication), and heart failure [@kannelFraminghamStudyEpidemiological1987].

Eligible participants included those who attended the 11th biennial check-up of the original cohort between 1968 and 1971 (a period when high-density lipoprotein [HDL] cholesterol measurements were available), or the first (1971-1975) or third (1984-1987) check-ups of the Offspring cohort, were aged between 30 and 74, and did not have CVD [@dagostinoGeneralCardiovascularRisk2008].

## 2.2 NHANES

The National Health and Nutrition Examination Survey (NHANES) [@NHANESNationalHealth] is a significant U.S. program aimed at assessing the health and nutritional status of adults and children. Managed by the National Center for Health Statistics (NCHS) under the CDC, NHANES combines interviews with physical examinations. Initiated in the early 1960s, the program has become a continuous effort since 1999, focusing on various health and nutrition topics. It examines about 5,000 individuals each year from a nationally representative sample, covering 15 counties each year. 

During the home interview, participants answer questions related to their health condition, medical history, and eating patterns, while in the health examination stage, they go thorough medical and dental assessments, accurate physiological measurements, and a range of detailed laboratory examinations, all conducted by trained medical staff. This comprehensive strategy guarantees an in-depth insight into the health profiles of the participants, building a strong foundation for thorough health and nutritional studies.

## 2.3 Missing Data

There is a lot of missing data in both datasets. When developing the risk score model based on the Framingham study, only complete records are used. As a result, the challenges of missing data in the Framingham study will not be considered. When transferring the model to NHANES, multiple imputation will be employed. Table 2 presents the percentage of missing data in NHANES. Some variables seem to exhibit a similar pattern of missing data. The `CURSMOKE` and `BPMEDS` variables each have a missing data rate of 36.72%, while the `HDLC` and `TOTCHOL` variables have identical missing percentages of 27.19%.

```{r}
# check missing data
df_2017_miss <- df_2017 %>% dplyr::select(colnames(df_2017[ ,colSums(is.na(df_2017))>0]))
# calculate the percentage of missing
df_2017_miss_pct <- data.frame(cbind(Number = colSums(is.na(df_2017_miss)), 
                                  Pct = paste0(round(100*colSums(is.na(df_2017_miss))/nrow(df_2017_miss), 2), "%"))) 

df_2017_miss_pct <- df_2017_miss_pct %>%
  arrange(desc(as.numeric(Number)))


df_2017_miss_pct$Variable <- rownames(df_2017_miss_pct)
rownames(df_2017_miss_pct) <- NULL
df_2017_miss_pct <- df_2017_miss_pct[, c(3,1,2)] # reorder the column

kable(df_2017_miss_pct, booktabs = T, escape = T, 
      caption = "Summary of Missing Values for NHANES",
      align = "c") %>%
  kable_styling(latex_options = c("HOLD_position"))
```

# 3. Transportability Analysis Methods

## 3.1. Multiple Imputation

Multiple imputation will be used to address the missing data in the NHANES dataset. This method creates several imputed datasets, thus introducing variability in the imputed values to reflect the uncertainty around the true values. The imputation will apply algorithms repetitively to generate values for the missing data. Then each dataset undergoes standard statistical analysis since it is complete. In this project, 5 complete NHANES datasets will be produced for analysis, the pooled Birer Score will be used.

## 3.2 Models

In this project, two gender-based models developed using the Framingham Dataset for predicting cardiovascular disease (CVD) will be adapted for use with the NHANES population. The NHANES data lacks relevant CVD outcomes with only covariates data. The models will be evaluated on three different datasets: the original Framingham Dataset, the NHANES dataset, and a simulated NHANES dataset. This evaluation aims to assess the transportability of the CVD risk score model. Since CVD is a binary outcome in the model, logistic regression models are used.

For Men: \begin{align*}
\text{logit}(P(\text{CVD})) = \ & \beta_0 + \beta_1 \log(\text{HDLC}) + \beta_2 \log(\text{TOTCHOL}) \\
& + \beta_3 \log(\text{AGE}) + \beta_4 \log(\text{SYSBP\_UT} + 1) \\
& + \beta_5 \log(\text{SYSBP\_T} + 1) + \beta_6 \text{CURSMOKE} + \beta_7 \text{DIABETES}
\end{align*}

For Women: \begin{align*}
\text{logit}(P(\text{CVD})) = \ & \gamma_0 + \gamma_1 \log(\text{HDLC}) + \gamma_2 \log(\text{TOTCHOL}) \\
& + \gamma_3 \log(\text{AGE}) + \gamma_4 \log(\text{SYSBP\_UT} + 1) \\
& + \gamma_5 \log(\text{SYSBP\_T} + 1) + \gamma_6 \text{CURSMOKE} + \gamma_7 \text{DIABETES}
\end{align*}

Here, $\text{logit}(P(\text{CVD}))$ represents the log-odds of cardiovascular disease (CVD). HDLC stands for High-Density Lipoprotein Cholesterol (mg/dL), TOTCHOL for Serum Total Cholesterol (mg/dL), and SYSBP for Systolic Blood Pressure, adjusted for the use of anti-hypertensive medication (BOMEDS). CURSMOKE indicates current cigarette smoking status (0 = Not a current smoker, 1 = Current smoker), and DIABETES represents the presence of diabetes based on the criteria of the first exam treated, or a casual glucose level of 200 mg/dL or more (0 = Not diabetic, 1 = Diabetic). The coefficients $\beta_i$ and $\gamma_i$ are for the men's and women's models respectively. The data will be split into 70-30 train-test sets. The model will be trained on the training data and then evaluated on the test data.

## 3.3 Simulation

The simulation is presented in the ADEMP structure [@morrisUsingSimulationStudies2019].

### Aim

The aim of the simulation is to evaluate the performance of the prediction model developed by Framingham study in the NHANES target population.

### Data-Generating Mechanism

When simulating the data, we assume that individual level data is not available from the target population NHANES and only summary statistics in Table 1 are available. When adjusting for the distribution of NHANES covariates, covariate data from the source population, Framingham, are used. The Shapiro-Wilk normality test is utilized to determine if simulations using a normal distribution are applicable. The results are consistently much smaller than the significance level of 0.05, leading to the rejection of the normality assumption. Therefore, we consider alternative distributions.

```{r, results='hide'}
shapiro.test(framingham_df$HDLC)
shapiro.test(framingham_df$TOTCHOL)
shapiro.test(framingham_df$AGE)
shapiro.test(framingham_df$SYSBP)
shapiro.test(framingham_df$DIABP)
shapiro.test(framingham_df$BMI)
```

By plotting the distribution of the covariates in the Framingham data, it can be observed that thedistribution are right-skewed. In the following plots, the black lines represent the densities of continuous variables of Framingham and the overlay blue lines are for gamma distribution using summary statistics with mean and standard deviation. 

With a known mean $\mu$ and standard deviation $\sigma$, the shape $k$ and scale $\theta$ of the gamma distribution will be $k = (\mu/\sigma)^2$ and $\theta = \sigma^2/\mu$. The plots show that the distributions of the actual data and the simulated data are very close, except for age, which shows a small deviation. 

As a result, Gamma distribution is then used to generate continuous variables in the simulated NHANES dataset based on the summary statistics. For binary variables, the binomial distribution is utilized. Each simulated dataset contains 4,557 men and 4,697 women, and is then subset according to the eligibility criteria of the Framingham dataset. The size of the simulation is $n_{sim}$=1000. All the simulation datasets are combined with the Framingham data and then test-train split.

```{r}
p1_men <- ggplot(framingham_df_men) + 
  geom_density(aes(x=HDLC)) + 
  stat_function(fun = dgamma, args = list(shape = (43.63/13.37)^2, scale = 13.37^2/43.63), 
                color = "blue") +
  ggtitle("Men") +
  theme(plot.title = element_text(hjust = 0.5, size = 15))

p2_men <- ggplot(framingham_df_men, aes(x=TOTCHOL)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (226.44/41.49)^2, scale = 41.49^2/ 226.44), 
                color = "blue") 

p3_men <- ggplot(framingham_df_men, aes(x=AGE)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (60.01/8.18)^2, scale = 8.18^2/60.01), 
                color = "blue") 

p4_men <- ggplot(framingham_df_men, aes(x=SYSBP)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (138.94/20.89)^2, scale = 20.89^2/ 138.94), 
                color = "blue") 

p5_men <- ggplot(framingham_df_men, aes(x=BMI)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (26.25/3.47)^2, scale = 3.47^2/26.25), 
                color = "blue") 

```

```{r}
p1_women <- ggplot(framingham_df_women) + 
  geom_density(aes(x=HDLC)) + 
  stat_function(fun = dgamma, args = list(shape = (53.07/15.67)^2, scale = 15.67^2/53.07), 
                color = "blue") +
  ggtitle("Women") +
  theme(plot.title = element_text(hjust = 0.5, size = 15))

p2_women <- ggplot(framingham_df_women, aes(x=TOTCHOL)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (246.32/45.51)^2, scale = 45.51^2/246.32), 
                color = "blue") 

p3_women <- ggplot(framingham_df_women, aes(x=AGE)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (60.55/8.40)^2, scale = 8.40^2/60.55), 
                color = "blue") 

p4_women <- ggplot(framingham_df_women, aes(x=SYSBP)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (139.94/23.71)^2, scale = 23.714^2/139.94), 
                color = "blue") 

p5_women <- ggplot(framingham_df_women, aes(x=BMI)) + 
  geom_density() +
  stat_function(fun = dgamma, args = list(shape = (25.55 /4.22)^2, scale = 4.22^2/25.55), 
                color = "blue") 

```

```{r, fig.width=12, fig.height=20}
plots <- ggarrange(
  p1_men, p1_women,
  p2_men, p2_women,
  p3_men, p3_women,
  p4_men, p4_women,
  p5_men, p5_women,
  ncol = 2, nrow = 5)

annotate_figure(plots, top = text_grob("Figure 1: Densities of actual Framingham study and simulated using Gamma distribution",  face = "bold", size = 15))
```

### Estimands

The estimands used in this simulation study is the Brier Scores in the source population and target population (which is equivalent to the MSE for binary outcomes). In the source population, the Brier Score can be calculated using the mean squared error (MSE) $(Y-g(X))^2$, which quantifies the discrepancy between the observed outcome $Y$ and the model $\text{Pr[Y=1|X, D=0]}$ derived prediction $g(X)$, where X is the covaraites.

In target population, the outcome variable is missing, which presents a challenge for calculations. Let S be an indicator for the population from which data are obtained, with S = 1 representing the source population Framingham and S = 0 representing the target population NHANES. The term $n = n_{source} + n_{target}$ is used to denote the total number of observations in the composite dataset, which consists of the data from both the source and target poopulation. Then the dataset is divided into a training set and a test set. Let D be an indicator distinguishing between the training and test data within the population. Therefore, the Brier Score for the target population is [@steingrimssonTransportingPredictionModel2023a]:

$$\hat{\psi}_{\hat{\beta}} = \frac{\sum_{i=1}^{n} I(S_{i} = 1, D_{\text{test}, i} = 1)\hat{o}(X_{i})(Y_{i} - g_{\hat{\beta}}(X_{i}))^2}{\sum_{i=1}^{n} I(S_{i} = 0, D_{\text{test}, i} = 1)}$$

where $\hat{o}(X)$ is an estimator for the inverse-odds weights in the test set, $$\frac{\text{Pr}[S=0|X, D_{test = 1}]}{\text{Pr}[S=1|X,D_{test = 1}]}.$$

The weights $\hat{o}(X)$ can be obtained by fitting a logistic regression model for the probability of the participants from the source population conditional on covariates $\text{Pr}[S=1|X,D_{test = 1}]$.

### Methods

Two logistic regression models presented in section 3.2 for male and female are fitted to predict CVD. Continuous variables are log-transformed. These models are developed on the training dataset and then evaluated on the test dataset.

### Performance Measures

The transportable ability is assessed by comparing the estimated Brier scores between the source population Framingham study, the NHANES population and the simulated NHANES population.

# 4. Results

```{r}

############################################
######## Brier Score for Framingham ########
############################################

# Test-train split
set.seed(1)
sample_men <- sample(c(TRUE, FALSE), nrow(framingham_df_men), replace=TRUE, prob=c(0.7,0.3))
sample_women <- sample(c(TRUE, FALSE), nrow(framingham_df_women), replace=TRUE, prob=c(0.7,0.3))

train_framingham_men  <- framingham_df_men[sample_men, ]
test_framingham_men   <- framingham_df_men[!sample_men, ]

train_framingham_women  <- framingham_df_women[sample_women, ]
test_framingham_women   <- framingham_df_women[!sample_women, ]
```

```{r}
# Fit models with log transforms for all continuous variables
mod_men_train <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+CURSMOKE+DIABETES, 
      data= train_framingham_men, family= "binomial")


mod_women_train <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, 
               data= train_framingham_women, family= "binomial")
```

```{r}
# Brier score
library(DescTools)
pred_test_men <- predict(mod_men_train, test_framingham_men[, -1], type = "response")
pred_test_women <- predict(mod_women_train, test_framingham_women[, -1], type = "response")
bs_fram_men <- mean((pred_test_men-test_framingham_men$CVD)^2)
bs_fram_women <- mean((pred_test_women-test_framingham_women$CVD)^2)
```

```{r}

############################################
########## Brier Score for NHANES ##########
############################################

# multiple imputation
library(mice)
# Check missing values and impute using mice package
df_2017 <- df_2017[, -c(11, 12)]
df_2017_mice_out <- mice(df_2017, 5, pri=F)

# Store each imputed data set
df_2017_imp <- vector("list",5)    
for (i in 1:5){
  df_2017_imp[[i]] <- mice::complete(df_2017_mice_out ,i) 
}

```
```{r}
# Get blood pressure based on whether or not on BPMEDS
for (i in 1:5){
  df_2017_imp[[i]]$SYSBP_UT <- ifelse(df_2017_imp[[i]]$BPMEDS == 0, 
                                 df_2017_imp[[i]]$SYSBP, 0)
  df_2017_imp[[i]]$SYSBP_T <- ifelse(df_2017_imp[[i]]$BPMEDS == 1, 
                                df_2017_imp[[i]]$SYSBP, 0)
}
```

```{r}
# Applying the eligibility criteria of Framingham on NHANES
for (i in 1:5){
  df_2017_imp[[i]] <- df_2017_imp[[i]] %>% filter(AGE <= 74 & AGE >= 30) %>% mutate(S = 0) 
}
```


```{r}
framingham_df_men <- framingham_df_men %>% 
  mutate(S = 1) %>% 
  select(CVD, SEX, TOTCHOL, AGE, SYSBP, CURSMOKE, DIABETES, BPMEDS, HDLC, BMI, SYSBP_UT, SYSBP_T, S)

framingham_df_women <- framingham_df_women %>% 
  mutate(S = 1) %>% 
  select(CVD, SEX, TOTCHOL, AGE, SYSBP, CURSMOKE, DIABETES, BPMEDS, HDLC, BMI, SYSBP_UT, SYSBP_T, S)
```

```{r}
# Split by gender
df_2017_imp_men <- vector("list", length = 5)
df_2017_imp_women <- vector("list", length = 5)

for (i in 1:5){
  df_2017_imp_men[[i]] <- df_2017_imp[[i]] %>% filter(SEX == 1)
  df_2017_imp_women[[i]] <- df_2017_imp[[i]] %>% filter(SEX == 2)
}

```

```{r}
# Create composite datasets
composite_imp_men <- vector("list", length = 5)
composite_imp_women <- vector("list", length = 5)

for (i in 1:5){
  composite_imp_men[[i]] <- merge(df_2017_imp_men[[i]], framingham_df_men, all = TRUE)
  composite_imp_women[[i]] <- merge(df_2017_imp_women[[i]], framingham_df_women, all = TRUE)
  
  set.seed(1)
  D_men <- sample(c(1, 0), nrow(composite_imp_men[[i]]), replace=TRUE, prob=c(0.3,0.7))
  D_women <- sample(c(1, 0), nrow(composite_imp_women[[i]]), replace=TRUE, prob=c(0.3,0.7))
  
  composite_imp_men[[i]] <- composite_imp_men[[i]] %>% mutate(D = D_men)
  composite_imp_women[[i]] <- composite_imp_women[[i]] %>% mutate(D = D_women)
}
```

```{r}
mod_men_train_list <- vector("list", length = 5)
mod_women_train_list <- vector("list", length = 5)

for(i in 1:5){
  # Fit models on training set
  mod_men_train_list[[i]] <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+CURSMOKE+DIABETES, 
      data= composite_imp_men[[i]][composite_imp_men[[i]]$S==1 &composite_imp_men[[i]]$D==0, ],
      family= "binomial")
  
  mod_women_train_list[[i]] <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, 
               data= composite_imp_women[[i]][composite_imp_women[[i]]$S==1 &composite_imp_women[[i]]$D==0, ],
               family= "binomial")
  
  # Predict on test set
  composite_imp_men[[i]]$prediction[composite_imp_men[[i]]$S==1 &composite_imp_men[[i]]$D==1] <- 
    predict(mod_men_train_list[[i]], 
            composite_imp_men[[i]][composite_imp_men[[i]]$S==1 &composite_imp_men[[i]]$D==1, ],
            type = "response")
  
  composite_imp_women[[i]]$prediction[composite_imp_women[[i]]$S==1 &composite_imp_women[[i]]$D==1] <-
    predict(mod_women_train_list[[i]], 
            composite_imp_women[[i]][composite_imp_women[[i]]$S==1 &composite_imp_women[[i]]$D==1, ],
            type = "response")
}

```

```{r}
trans_brier <- function(df){
  #' Calculate the Brier Score for transporting a prediction model for a new target population
  #'
  #' @param df The composite dataframe of Framingham study and NHANES
  #' @return A numeric number of the transportation Brier Score.
  
  model_S <- glm(S ~ log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, data = df[df$D == 1, ], family = "binomial")
  df$sigma_hat[df$D==1] <- 1/predict(model_S, type = "response")
  
  df_sub <- df[df$S == 1 & df$D == 1, ]
  
  sum(df_sub$sigma_hat * (df_sub$CVD - df_sub$prediction)^2)/sum(df$S == 0 & df$D == 1)
}
```

```{r, results='hide'}
# Test trains_brier function
trans_brier(composite_imp_men[[1]])
trans_brier(composite_imp_women[[1]])
```
```{r}
brier_imp_men <- numeric(length = 5)
brier_imp_women <- numeric(length = 5)

for(i in 1:5){
  brier_imp_men[i] <- trans_brier(composite_imp_men[[i]])
  brier_imp_women[i] <- trans_brier(composite_imp_women[[i]])
}

bs_imp_men <- mean(brier_imp_men)
bs_imp_women <- mean(brier_imp_women)

sd_imp_men <- sd(brier_imp_men)
sd_imp_women <- sd(brier_imp_women)
```

```{r}
##################################################
######## Brier Score for simulated NHANES ########
##################################################


# Data simulating function
simulate_data <- function() {
  # Binary variables
  CURSMOKE_men <- rbinom(4557, 1, prob = 0.21)
  CURSMOKE_women <- rbinom(4697, 1, prob = 0.14)

  BPMEDS_men <- rbinom(4557, 1, prob = 0.28)
  BPMEDS_women <- rbinom(4697, 1, prob = 0.28)

  DIABETES_men <- rbinom(4557, 1, prob = 0.11)
  DIABETES_women <- rbinom(4697, 1, prob = 0.09)

  # Continuous variables
  simulated_hdlc_men <- rgamma(4557, shape = (49.57 / 13.53)^2, scale = 13.53^2 / 49.57)
  simulated_hdlc_women <- rgamma(4697, shape = (57.01 / 14.94)^2, scale = 14.94^2 / 57.01)

  simulated_totchol_men <- rgamma(4557, shape = (176.68 / 40.38)^2, scale = 40.38^2 / 176.68)
  simulated_totchol_women <- rgamma(4697, shape = (182.94 / 40.59)^2, scale = 40.59^2 / 182.94)

  simulated_sysbp_men <- rgamma(4557, shape = (122.49 / 18.71)^2, scale = 18.71^2 / 122.49)
  simulated_sysbp_women <- rgamma(4697, shape = (120.20 / 21.09)^2, scale = 21.09^2 / 120.20)

  simulated_bmi_men <- rgamma(4557, shape = (26.16 / 7.63)^2, scale = 7.63^2 / 26.16)
  simulated_bmi_women <- rgamma(4697, shape = (26.98 / 8.80)^2, scale = 8.80^2 / 26.98)

  simulated_age_men <- rgamma(4557, shape = (34.12 / 25.75)^2, scale = 25.75^2 / 34.12)
  simulated_age_women <- rgamma(4697, shape = (34.55 / 25.25)^2, scale = 25.25^2 / 34.55)

  # Combine into dataframes
  men_df <- data.frame(
    SEX = rep(1, 4557),
    CURSMOKE = CURSMOKE_men,
    BPMEDS = BPMEDS_men,
    DIABETES = DIABETES_men,
    HDLC = simulated_hdlc_men,
    TOTCHOL = simulated_totchol_men,
    SYSBP = simulated_sysbp_men,
    BMI = simulated_bmi_men,
    AGE = simulated_age_men,
    S = rep(0, 4557)
  )

  women_df <- data.frame(
    SEX = rep(2, 4697),
    CURSMOKE = CURSMOKE_women,
    BPMEDS = BPMEDS_women,
    DIABETES = DIABETES_women,
    HDLC = simulated_hdlc_women,
    TOTCHOL = simulated_totchol_women,
    SYSBP = simulated_sysbp_women,
    BMI = simulated_bmi_women,
    AGE = simulated_age_women,
    S = rep(0, 4697) 
  )

  # Combine men and women dataframes
  df <- rbind(men_df, women_df)
  df$SYSBP_UT <- ifelse(df$BPMEDS == 0, 
                                 df$SYSBP, 0)
  df$SYSBP_T <- ifelse(df$BPMEDS == 1, 
                                df$SYSBP, 0)

  return(df)
}

```

```{r}
simu_brier_func <- function(){
  # Call the function to get the simulated data
  simulated_data_df <- simulate_data()
  
  simulated_data_df_men <- simulated_data_df %>% filter(SEX == 1, AGE <= 74 & AGE >= 30)
  simulated_data_df_women <- simulated_data_df %>% filter(SEX == 2, AGE <= 74 & AGE >= 30)
  
  composite_sim_men <- merge(simulated_data_df_men, framingham_df_men, all = TRUE)
  composite_sim_women <- merge(simulated_data_df_women , framingham_df_women, all = TRUE)
  
  D_men <- sample(c(1, 0), nrow(composite_sim_men), replace=TRUE, prob=c(0.3,0.7))
  D_women <- sample(c(1, 0), nrow(composite_sim_women), replace=TRUE, prob=c(0.3,0.7))
  
  composite_sim_men <- composite_sim_men %>% mutate(D = D_men)
  composite_sim_women <- composite_sim_women %>% mutate(D = D_women)
  
  mod_men_sim_train <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                 log(SYSBP_T+1)+CURSMOKE+DIABETES, 
      data= composite_sim_men[composite_sim_men$S==1 &composite_sim_men$D==0, ],
      family= "binomial")
  
  mod_women_sim_train <- glm(CVD~log(HDLC)+log(TOTCHOL)+log(AGE)+log(SYSBP_UT+1)+
                   log(SYSBP_T+1)+CURSMOKE+DIABETES, 
               data= composite_sim_women[composite_sim_women$S==1 &composite_sim_women$D==0, ],
               family= "binomial")
  
  # Predict on test set
  composite_sim_men$prediction[composite_sim_men$S==1 & composite_sim_men$D==1] <- 
    predict(mod_men_sim_train, 
            composite_sim_men[composite_sim_men$S==1 & composite_sim_men$D==1, ],
            type = "response")
  
  composite_sim_women$prediction[composite_sim_women$S==1 & composite_sim_women$D==1] <-
    predict(mod_women_sim_train, 
            composite_sim_women[composite_sim_women$S==1 & composite_sim_women$D==1, ],
            type = "response")
  
  return(c(trans_brier(composite_sim_men), trans_brier(composite_sim_women)))
}

```

```{r, results='hide'}
# Test simu_brier_func()
simu_brier_func()
```

```{r, eval=FALSE}
# Initialize vectors to store Brier scores
brier_scores <- matrix(nrow = 2000, ncol = 2)

# Perform 2000 simulations
set.seed(1)
for(i in 1:2000) {
  brier_scores[i, ] <- simu_brier_func()
}
```

```{r, eval=FALSE}
colnames(brier_scores) <- c("men", "women")
save(brier_scores, file = "brier_scores.RData")
```


```{r}
# Restore the object
load("brier_scores.RData")
```

```{r}
# Calculate mean Brier scores at each simulation step
mean_brier_men <- cumsum(brier_scores[,1]) / 1:2000
mean_brier_women <- cumsum(brier_scores[,2]) / 1:2000
sd_brier_men <- sd(brier_scores[, 1])
sd_brier_women <- sd(brier_scores[, 2])
```

```{r}
brier_df <- data.frame(Estimate = c("Mean", "SD", "Mean", "SD"),
                       Framingham = round(c(bs_fram_men, NA, bs_fram_women, NA), 4),
                       NHANES = round(c(bs_imp_men, sd_imp_men, bs_imp_women, sd_imp_women), 4),
                       Sim_NHANES = round(c(mean_brier_men[2000], sd_brier_men, 
                                      mean_brier_women[2000], sd_brier_women), 4))

rownames(brier_df) <- c("Men", "", "Women", " ")
colnames(brier_df) <- c("Statistics", "Framingham", "NHANES", "Simulated NHANES (n = 2000)")
```

Table 3 summarizes the Brier Scores for the cardiovascular disease (CVD) risk prediction model across three datasets: Framingham, NHANES, and Simulated NHANES. It is observed that for both genders, the Brier Scores and their standard deviations are consistently higher in men than in women.

A lower Brier Score suggests a better accuracy of the model. For the Framingham dataset, the Brier Scores were 0.1917 for men and 0.1176 for women, suggesting more precise predictions for women. 

When transporting this model to the NHANES data, there was an increase in Brier Scores, indicating less accuracy compared to the original Framingham data. The average Brier Score for men across the five imputation dataset is 0.2178 while for women is was 0.1250. The model for women still performs better than men. The standard deviation of Brier scores for women is smaller than men, suggesting more stable predictions.

Simulations based on summary statistics yielded the smallest Brier Scores among the datasets, with the mean Brier Score for the 2000 simulated datasets being 0.1819 for men and 0.1165 for women, suggesting that the model performed best on the simulated data. The standard deviation for women remained smaller than for men.
```{r}
brier_df[is.na(brier_df)] <- "-"
brier_df %>% kable(booktabs = T, escape = F, align = "c", caption = "Summary of the Brier Scores") %>%
  kable_styling(latex_options = c("HOLD_position"))
```

Figure 2 further illustrates the results of the simulation study, plotting the changes in Brier Scores against the number of simulations for both men and women. It shows the variability and convergence of the mean Brier Score as the number of simulations increases. The figure on the left for men, displays initial fluctuations. However, as the number of simulations is over 1000, the mean Brier Score stabilizes and converges to a value around 0.1819. The figure on the right for women, also demonstrates initial variability, but the mean Brier Score stabilizes and converges more quickly than men, eventually reaching a value around 0.1165. It indicates a more consistent prediction model for women compared to men, aligning with our results in Table 3 regarding the standard deviation.
```{r}
plot_data_men <- data.frame(
  Simulation = 1:2000,
  MeanBrier = mean_brier_men
)

plot_data_women <- data.frame(
  Simulation = 1:2000,
  MeanBrier = mean_brier_women
)

# Plotting for men
p1_sim_men <- ggplot(plot_data_men, aes(x = Simulation, y = MeanBrier)) +
  geom_line(color = "blue") +
  labs(title = "Men", x = "Number of Simulations", y = "Mean Brier Score") +
  theme_minimal()

# Plotting for women
p2_sim_women <- ggplot(plot_data_women, aes(x = Simulation, y = MeanBrier)) +
  geom_line(color = "red") +
  labs(title = "Women", x = "Number of Simulations", y = "Mean Brier Score") +
  theme_minimal()
```


```{r, fig.width = 15, fig.height = 8}
simu_plot <- ggarrange(p1_sim_men, p2_sim_women)
annotate_figure(simu_plot, top = text_grob("Figure 2: Changes of mean Brier Score with the Number of Simulation",  face = "bold", size = 15))
```

# 5. Discussion

In this project, the Brier Score is used to estimate the transferability of CVD prediction models to a target population during model development when outcome and covariate data are available from the source population, and only covariate data are available from the target population. Two logistic models for men and women have been developed using population data from the Framingham study. The model performance is estimated without specifying the model in the NHANES population. The formula for transportability analysis takes into account both the source and target populations.

Our results indicate that across all three datasets, the model consistently performs better for women than for men, suggesting underlying differences in CVD risk-related covariates. The model for women demonstrates a higher capacity for application across various female populations.

When comparing the results across the datasets, it shows that the Brier Scores for the NHANES population are the highest, while those for the simulated NHANES population are the lowest. The model performs better on Framingham data than on NHANES data because it is developed based on the former, and the covariates of the NHANES data are significantly different from those of the Framingham data. The model can represent the Framingham data more accurately than the NHANES data since the measures of model performance are essentially an average of the covariate distribution. Therefore, when the distributions of the covaraites are different, the predictions will deviate. 

The simulated data performs best might be due to that the simulated data is not able capture the full complexity of the real-world data. In our simulations, only Gamma and Binomial distributions are used. Although the density plots for most covariates are close, age shows a deviation, and the Gamma distribution has fewer outliers compared to real-world data. Moreover, since we assume we do not have the individual data of NHANES when simulating, we can only refer to the distribution from the Framingham study. However, the actual distribution in NHANES may not follow the covariate distributions observed in Framingham.

There are also some limitations to our project. Firstly,  the implemented Brier Score for transportability relies on two identifiable conditions, A1 and A2 [@steingrimssonTransportingPredictionModel2023a]: A1 needs the independence of the outcome Y and the population S given the covariates, and A2 is positivity, suggesting $\text{Pr}[S=1|X=x]>0$ for every $x$ where the joint density of $f(X=x, S = 0) \neq 0$. These conditions might not be satisfied in other datasets, which limits the usage of this metric. Future studies could consider additional performance measures, such as AUC (Area Under the ROC Curve), for a more comprehensive assessment of the model. Moreover, alternative distributions and methods could be explored for simulation purposes. The issue of missing data in the Framingham population has not been considered in our projct, thus new transportability analysis tools could also be developed to address this problem.

# References
